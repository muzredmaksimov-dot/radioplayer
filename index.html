<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–¥–∏–æ –ú–ò–†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .close-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #ffffff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(255,255,255,0.3);
        }
        
        .slogan {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 12px;
            opacity: 0.7;
            font-weight: 300;
        }
        
        .player-card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .now-playing {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .station-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .station-badge {
            background: linear-gradient(45deg, #ff4081, #f50057);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .live-dot {
            width: 6px;
            height: 6px;
            background: #ff5252;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .song-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            min-height: 32px;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #ffffff, #bbdefb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .song-artist {
            font-size: 16px;
            opacity: 0.9;
            min-height: 22px;
            transition: all 0.3s ease;
            font-weight: 400;
        }
        
        .player-controls {
            margin: 35px 0;
            display: flex;
            justify-content: center;
        }
        
        .play-btn {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            border: none;
            color: white;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }
        
        .play-btn:active {
            transform: scale(0.95);
        }
        
        .play-icon {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 18px 0 18px 32px;
            border-color: transparent transparent transparent white;
            margin-left: 4px;
        }
        
        .pause-icon {
            width: 32px;
            height: 36px;
            display: flex;
            justify-content: space-between;
        }
        
        .pause-bar {
            width: 10px;
            height: 100%;
            background: white;
            border-radius: 3px;
        }
        
        .status {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 20px;
            text-align: center;
            font-weight: 300;
        }
        
        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 11px;
            opacity: 0.6;
            font-weight: 300;
        }
        
        .organization {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        .debug-info {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 10px;
            margin-top: 15px;
            font-size: 10px;
            opacity: 0.6;
            display: none;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–µ–∫–æ–≤ */
        .track-history {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            margin-top: 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .track-history.expanded {
            max-height: 150px;
        }
        
        .history-title {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .history-item {
            font-size: 11px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-track {
            flex: 1;
        }
        
        .history-time {
            opacity: 0.5;
            font-size: 10px;
            min-width: 40px;
            text-align: right;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–º–µ–Ω—ã —Ç—Ä–µ–∫–∞ */
        .track-change {
            animation: trackChange 0.5s ease;
        }
        
        @keyframes trackChange {
            0% { opacity: 0.5; transform: translateX(-10px); }
            100% { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <div class="container fade-in">
        
        <div class="logo-section">
            <div class="logo">–ú–ò–†</div>
            <div class="slogan">–í—Å–µ –≤–∫–ª—é—á–µ–Ω–æ!</div>
        </div>
        
        <div class="player-card">
            <div class="now-playing">
                <div class="station-info">
                    <div class="station-badge">–≠–§–ò–†</div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>LIVE</span>
                    </div>
                </div>
                <div class="song-title" id="currentSong">–†–∞–¥–∏–æ –ú–ò–†</div>
                <div class="song-artist" id="currentArtist">–û–∂–∏–¥–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...</div>
            </div>
            
            <div class="player-controls">
                <button class="play-btn" onclick="togglePlay()" id="playBtn">
                    <div class="play-icon" id="playIcon"></div>
                </button>
            </div>
            
            <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —ç—Ñ–∏—Ä—É...</div>
            
            <div class="debug-info" id="debugInfo">
                <div>–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö</div>
                <div id="metadataLog"></div>
            </div>
            
            <div class="track-history" id="trackHistory">
                <div class="history-title">–ù–µ–¥–∞–≤–Ω–æ –∑–≤—É—á–∞–ª–æ:</div>
                <div id="historyList"></div>
            </div>
        </div>
        
        <div class="footer">
            <div class="organization">
                –ú–µ–∂–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–µ–ª–µ—Ä–∞–¥–∏–æ–∫–æ–º–ø–∞–Ω–∏—è ¬´–ú–ò–†¬ª<br>
                –†–µ—Å–ø—É–±–ª–∏–∫–∞ –ë–µ–ª–∞—Ä—É—Å—å
            </div>
        </div>
        
        <audio id="audioPlayer" preload="none"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        
        // –ü–æ—Ç–æ–∫ —Ä–∞–¥–∏–æ –ú–ò–†
        const STREAM_URL = 'https://media1.datacenter.by:1936/radiomir/radiomir/playlist.m3u8';
        
        let hls;
        let isPlaying = false;
        let currentMetadata = { title: '–†–∞–¥–∏–æ –ú–ò–†', artist: '–û–∂–∏–¥–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö...' };
        let trackHistory = [];
        let lastProcessedMetadata = '';

        // –í–∫–ª—é—á–∏–º –æ—Ç–ª–∞–¥–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        const DEBUG_METADATA = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        tg.expand();

        function initHLS() {
            console.log('üéµ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞–¥–∏–æ –ú–ò–†...');
            
            if (Hls.isSupported()) {
                hls = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    debug: DEBUG_METADATA,
                    enableCEA708Captions: true,
                    enableWebVTT: true
                });
                
                hls.loadSource(STREAM_URL);
                hls.attachMedia(audio);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    console.log('‚úÖ –ú–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
                    updateStatus('–≠—Ñ–∏—Ä –≥–æ—Ç–æ–≤ - –Ω–∞–∂–º–∏—Ç–µ PLAY');
                    logMetadata('–ú–∞–Ω–∏—Ñ–µ—Å—Ç —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω');
                });
                
                // –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
                hls.on(Hls.Events.FRAG_PARSING_METADATA, function(event, data) {
                    logMetadata('–ü–æ–ª—É—á–µ–Ω—ã –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ FRAG_PARSING_METADATA', data);
                    if (data.samples && data.samples.length > 0) {
                        parseMetadataSamples(data.samples);
                    }
                });
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
                hls.on(Hls.Events.FRAG_PARSING_INIT_SEGMENT, function(event, data) {
                    logMetadata('Init segment –¥–∞–Ω–Ω—ã–µ', data);
                });
                
                hls.on(Hls.Events.FRAG_PARSING_USERDATA, function(event, data) {
                    logMetadata('Userdata –ø–æ–ª—É—á–µ–Ω—ã', data);
                });
                
                hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, function(event, data) {
                    logMetadata('–°—É–±—Ç–∏—Ç—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', data);
                });
                
                hls.on(Hls.Events.CUES_PARSED, function(event, data) {
                    logMetadata('–ö—å—é–∑—ã —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã', data);
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS Error:', data);
                    if (data.fatal) {
                        updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                    }
                });
                
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                // –î–ª—è Safari
                audio.src = STREAM_URL;
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —ç—Ñ–∏—Ä—É...');
            } else {
                updateStatus('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é');
            }
        }

        function parseMetadataSamples(samples) {
            let foundMetadata = false;
            
            samples.forEach((sample, index) => {
                logMetadata(`–û–±—Ä–∞–∑–µ—Ü ${index + 1}/${samples.length}:`, {
                    type: sample.type,
                    pts: sample.pts,
                    dts: sample.dts,
                    duration: sample.duration,
                    data: sample.data ? sample.data.byteLength + ' bytes' : 'no data'
                });
                
                if (sample.type === 'ID3') {
                    if (parseID3Data(sample.data)) {
                        foundMetadata = true;
                    }
                } else if (sample.type === 'text') {
                    if (parseTextMetadata(sample)) {
                        foundMetadata = true;
                    }
                }
            });
            
            return foundMetadata;
        }

        function parseID3Data(data) {
            try {
                const dataView = new DataView(data);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º ID3 header
                if (dataView.getUint16(0) !== 0x4944) { // 'ID'
                    logMetadata('–ù–µ–≤–µ—Ä–Ω—ã–π ID3 header');
                    return false;
                }
                
                const majorVersion = dataView.getUint8(3);
                const revision = dataView.getUint8(4);
                logMetadata(`ID3 –≤–µ—Ä—Å–∏—è: 2.${majorVersion}.${revision}`);
                
                let offset = 10; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º ID3 header
                let foundFrames = false;
                
                while (offset < dataView.byteLength - 10) {
                    try {
                        const frameId = getString(dataView, offset, 4);
                        const size = dataView.getUint32(offset + 4);
                        
                        if (size === 0) break;
                        
                        offset += 10; // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –¥–∞–Ω–Ω—ã–º —Ñ—Ä–µ–π–º–∞
                        
                        logMetadata(`–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ—Ä–µ–π–º–∞: ${frameId}, —Ä–∞–∑–º–µ—Ä: ${size} bytes`);
                        
                        if (processID3Frame(frameId, dataView, offset, size)) {
                            foundFrames = true;
                        }
                        
                        offset += size;
                    } catch (e) {
                        logMetadata(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ñ—Ä–µ–π–º–∞: ${e.message}`);
                        break;
                    }
                }
                
                if (foundFrames) {
                    updateTrackDisplay();
                    return true;
                }
                
            } catch (error) {
                logMetadata(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ID3: ${error.message}`);
            }
            
            return false;
        }

        function getString(dataView, offset, length) {
            let result = '';
            for (let i = 0; i < length; i++) {
                const char = dataView.getUint8(offset + i);
                if (char === 0) break;
                result += String.fromCharCode(char);
            }
            return result;
        }

        function processID3Frame(frameId, dataView, offset, size) {
            try {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–ª–∞–≥–∏
                const encoding = dataView.getUint8(offset);
                let textOffset = offset + 1;
                
                let frameData = '';
                
                if (encoding === 0 || encoding === 3) {
                    // ISO-8859-1 –∏–ª–∏ UTF-8
                    frameData = getString(dataView, textOffset, size - 1);
                } else if (encoding === 1 || encoding === 2) {
                    // UTF-16 —Å BOM
                    frameData = decodeUTF16(dataView, textOffset, size - 1);
                }
                
                frameData = frameData.trim();
                
                if (!frameData) return false;
                
                logMetadata(`–§—Ä–µ–π–º ${frameId}: "${frameData}"`);
                
                switch(frameId) {
                    case 'TIT2':
                    case 'TT2': // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è ID3v2.2
                        if (frameData !== currentMetadata.title) {
                            currentMetadata.title = frameData;
                            return true;
                        }
                        break;
                        
                    case 'TPE1':
                    case 'TP1': // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è ID3v2.2
                        if (frameData !== currentMetadata.artist) {
                            currentMetadata.artist = frameData;
                            return true;
                        }
                        break;
                        
                    case 'TALB':
                    case 'TAL': // –ê–ª—å–±–æ–º
                        currentMetadata.album = frameData;
                        break;
                        
                    case 'COMM':
                    case 'COM': // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        if (parseCommentMetadata(frameData)) {
                            return true;
                        }
                        break;
                        
                    default:
                        // –ü—Ä–æ–±—É–µ–º –ø–∞—Ä—Å–∏—Ç—å –ª—é–±—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ—Ä–µ–π–º—ã
                        if (frameData.includes(' - ')) {
                            if (parseGenericMetadata(frameData)) {
                                return true;
                            }
                        }
                        break;
                }
                
            } catch (error) {
                logMetadata(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ—Ä–µ–π–º–∞ ${frameId}: ${error.message}`);
            }
            
            return false;
        }

        function decodeUTF16(dataView, offset, length) {
            try {
                const bytes = new Uint8Array(dataView.buffer, offset, length);
                // –ü—Ä–æ—Å—Ç–∞—è UTF-16 –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∫–∞ (little-endian)
                let result = '';
                for (let i = 0; i < bytes.length - 1; i += 2) {
                    const charCode = (bytes[i + 1] << 8) | bytes[i];
                    if (charCode !== 0) {
                        result += String.fromCharCode(charCode);
                    }
                }
                return result;
            } catch (e) {
                return '';
            }
        }

        function parseCommentMetadata(text) {
            // –ü–∞—Ä—Å–∏–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å - –¢—Ä–µ–∫"
            const patterns = [
                /^(.+?)\s*[-‚Äì‚Äî]\s*(.+)$/, // –†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –¥–µ—Ñ–∏—Å–æ–≤
                /^(.+?)\s*[\|]\s*(.+)$/   // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è —á–µ—Ä—Ç–∞
            ];
            
            for (let pattern of patterns) {
                const match = text.match(pattern);
                if (match) {
                    const artist = cleanText(match[1]);
                    const title = cleanText(match[2]);
                    
                    if (artist && title && 
                        artist !== currentMetadata.artist && 
                        title !== currentMetadata.title) {
                        
                        currentMetadata.artist = artist;
                        currentMetadata.title = title;
                        logMetadata(`–†–∞—Å–ø–∞—Ä—Å–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "${artist}" - "${title}"`);
                        return true;
                    }
                }
            }
            return false;
        }

        function parseGenericMetadata(text) {
            // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –ª—é–±—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            if (text.includes(' - ')) {
                const parts = text.split(' - ');
                if (parts.length === 2) {
                    const part1 = cleanText(parts[0]);
                    const part2 = cleanText(parts[1]);
                    
                    if (part1 && part2) {
                        // –≠–≤—Ä–∏—Å—Ç–∏–∫–∞: –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–±—ã—á–Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                        if (part1.length <= part2.length) {
                            currentMetadata.artist = part1;
                            currentMetadata.title = part2;
                        } else {
                            currentMetadata.artist = part2;
                            currentMetadata.title = part1;
                        }
                        logMetadata(`–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥: "${currentMetadata.artist}" - "${currentMetadata.title}"`);
                        return true;
                    }
                }
            }
            return false;
        }

        function parseTextMetadata(sample) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (WebVTT, CEA-708 –∏ —Ç.–¥.)
            if (sample.text) {
                logMetadata(`–¢–µ–∫—Å—Ç–æ–≤—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: ${sample.text}`);
                return parseGenericMetadata(sample.text);
            }
            return false;
        }

        function cleanText(text) {
            return text.replace(/\0/g, '')
                      .replace(/^\s+|\s+$/g, '')
                      .replace(/\s+/g, ' ')
                      .substring(0, 100);
        }

        function logMetadata(message, data = null) {
            if (!DEBUG_METADATA) return;
            
            const logElement = document.getElementById('metadataLog');
            const debugElement = document.getElementById('debugInfo');
            
            if (logElement && debugElement) {
                debugElement.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString();
                let logMessage = `[${timestamp}] ${message}`;
                
                if (data) {
                    logMessage += `: ${JSON.stringify(data, null, 2).substring(0, 200)}`;
                }
                
                logElement.innerHTML = logMessage + '<br>' + logElement.innerHTML;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ª–æ–≥ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                const lines = logElement.innerHTML.split('<br>');
                if (lines.length > 10) {
                    logElement.innerHTML = lines.slice(0, 10).join('<br>');
                }
            }
            
            console.log('üì° –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:', message, data);
        }

        function updateTrackDisplay() {
            const titleElement = document.getElementById('currentSong');
            const artistElement = document.getElementById('currentArtist');
            
            if (!titleElement || !artistElement) return;
            
            const currentTrackString = currentMetadata.title + currentMetadata.artist;
            if (currentTrackString === lastProcessedMetadata) return;
            
            lastProcessedMetadata = currentTrackString;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —Å–º–µ–Ω—ã —Ç—Ä–µ–∫–∞
            titleElement.classList.add('track-change');
            artistElement.classList.add('track-change');
            
            setTimeout(() => {
                titleElement.textContent = currentMetadata.title;
                artistElement.textContent = currentMetadata.artist;
                
                setTimeout(() => {
                    titleElement.classList.remove('track-change');
                    artistElement.classList.remove('track-change');
                }, 500);
            }, 100);
            
            updateStatus('–í —ç—Ñ–∏—Ä–µ: ' + currentMetadata.title);
            addToHistory(currentMetadata.title, currentMetadata.artist);
            
            logMetadata(`–û–±–Ω–æ–≤–ª–µ–Ω —Ç—Ä–µ–∫: "${currentMetadata.title}" - "${currentMetadata.artist}"`);
        }

        function addToHistory(title, artist) {
            const timestamp = new Date().toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ª–∏ —Ç—Ä–µ–∫
            const lastTrack = trackHistory[0];
            if (lastTrack && lastTrack.title === title && lastTrack.artist === artist) {
                return;
            }
            
            trackHistory.unshift({
                title,
                artist,
                timestamp,
                id: Date.now()
            });
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 5 —Ç—Ä–µ–∫–∞–º–∏
            if (trackHistory.length > 5) {
                trackHistory = trackHistory.slice(0, 5);
            }
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            const trackHistoryElement = document.getElementById('trackHistory');
            
            if (!historyList || !trackHistoryElement) return;
            
            historyList.innerHTML = trackHistory.map(track => 
                `<div class="history-item">
                    <div class="history-track">
                        <strong>${track.title}</strong> - ${track.artist}
                    </div>
                    <div class="history-time">${track.timestamp}</div>
                </div>`
            ).join('');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å–∏
            if (trackHistory.length > 0) {
                trackHistoryElement.classList.add('expanded');
            }
        }

        function togglePlay() {
            if (!hls && !audio.src) {
                initHLS();
                updateStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                return;
            }
            
            if (isPlaying) {
                audio.pause();
                showPlayIcon();
                updateStatus('–ü–∞—É–∑–∞');
            } else {
                audio.play().then(() => {
                    showPauseIcon();
                    updateStatus('–°–ª—É—à–∞–µ–º —ç—Ñ–∏—Ä...');
                }).catch(error => {
                    console.error('Play failed:', error);
                    updateStatus('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
                });
            }
            isPlaying = !isPlaying;
        }

        function showPlayIcon() {
            playIcon.className = 'play-icon';
            playIcon.innerHTML = '';
        }

        function showPauseIcon() {
            playIcon.className = 'pause-icon';
            playIcon.innerHTML = '<div class="pause-bar"></div><div class="pause-bar"></div>';
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        function closeApp() {
            if (hls) {
                hls.destroy();
            }
            audio.pause();
            tg.close();
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏–æ
        audio.addEventListener('play', () => {
            showPauseIcon();
            isPlaying = true;
            updateStatus('–≠—Ñ–∏—Ä –æ–Ω–ª–∞–π–Ω');
        });

        audio.addEventListener('pause', () => {
            showPlayIcon();
            isPlaying = false;
            updateStatus('–ü–∞—É–∑–∞');
        });

        audio.addEventListener('waiting', () => {
            updateStatus('–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è...');
        });

        audio.addEventListener('playing', () => {
            updateStatus('–≠—Ñ–∏—Ä –æ–Ω–ª–∞–π–Ω');
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        updateTrackDisplay();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            initHLS();
        });

    </script>
</body>
</html>
