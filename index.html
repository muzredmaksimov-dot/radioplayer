<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Радио МИР</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
body { margin:0; padding:20px; background:linear-gradient(135deg,#1a237e 0%,#283593 50%,#3949ab 100%); color:white; font-family:sans-serif; }
.container { max-width:400px; margin:0 auto; }
.logo-section { text-align:center; margin-bottom:30px; }
.logo { font-size:42px; font-weight:bold; background:linear-gradient(45deg,#fff,#bbdefb); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.slogan { font-size:16px; opacity:0.9; }
.player-card { background:rgba(255,255,255,0.08); backdrop-filter:blur(20px); border-radius:24px; padding:30px 25px; margin-bottom:20px; }
.now-playing { text-align:center; margin-bottom:30px; }
.song-title { font-size:22px; font-weight:600; min-height:32px; background:linear-gradient(45deg,#fff,#bbdefb); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.song-artist { font-size:16px; opacity:0.9; min-height:22px; }
.player-controls { display:flex; justify-content:center; margin:30px 0; }
.play-btn { background:linear-gradient(45deg,#2196f3,#1976d2); border:none; width:90px; height:90px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.play-icon { width:0; height:0; border-style:solid; border-width:18px 0 18px 32px; border-color:transparent transparent transparent white; margin-left:4px; }
.pause-icon { width:32px; height:36px; display:flex; justify-content:space-between; }
.pause-bar { width:10px; height:100%; background:white; border-radius:3px; }
.status { text-align:center; font-size:13px; opacity:0.8; margin-top:20px; }
.track-history { background:rgba(255,255,255,0.05); border-radius:16px; padding:15px; max-height:0; overflow:hidden; transition:max-height 0.3s ease; margin-top:20px; }
.track-history.expanded { max-height:150px; }
.history-title { font-size:12px; opacity:0.7; margin-bottom:10px; font-weight:500; }
.history-item { font-size:11px; padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.1); display:flex; justify-content:space-between; }
.history-item:last-child { border-bottom:none; }
.history-track { flex:1; }
.history-time { opacity:0.5; font-size:10px; }
</style>
</head>
<body>
<div class="container">
    <div class="logo-section">
        <div class="logo">МИР</div>
        <div class="slogan">Все включено!</div>
    </div>

    <div class="player-card">
        <div class="now-playing">
            <div class="song-title" id="currentSong">Загрузка эфира...</div>
            <div class="song-artist" id="currentArtist">Радио МИР</div>
        </div>
        <div class="player-controls">
            <button class="play-btn" onclick="togglePlay()" id="playBtn">
                <div class="play-icon" id="playIcon"></div>
            </button>
        </div>
        <div class="status" id="status">Подключение к эфиру...</div>
        <div class="track-history" id="trackHistory">
            <div class="history-title">Недавно звучало:</div>
            <div id="historyList"></div>
        </div>
    </div>

    <audio id="audioPlayer" preload="none"></audio>
</div>

<script>
const audio = document.getElementById('audioPlayer');
const playBtn = document.getElementById('playBtn');
const playIcon = document.getElementById('playIcon');
const STREAM_URL = 'https://media1.datacenter.by:1936/radiomir/radiomir/playlist.m3u8';
let hls;
let isPlaying = false;
let currentMetadata = {title:'', artist:''};
let lastMetadata = '';
let trackHistory = [];

// HLS инициализация
function initHLS() {
    if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(STREAM_URL);
        hls.attachMedia(audio);
        hls.on(Hls.Events.MANIFEST_PARSED, () => { updateStatus('Эфир подключен'); });
        hls.on(Hls.Events.FRAG_PARSING_METADATA, (event,data)=>{ parseMetadata(data); });
        hls.on(Hls.Events.ERROR, (event,data)=>{ console.error('HLS Error', data); updateStatus('Ошибка эфира'); });
    } else if(audio.canPlayType('application/vnd.apple.mpegurl')) {
        audio.src = STREAM_URL;
        updateStatus('Подключение к эфиру...');
    } else { updateStatus('Браузер не поддерживает HLS'); }
}

// Парсинг любых метаданных
function parseMetadata(data) {
    if(!data.samples) return;
    data.samples.forEach(s=>{
        if(s.type==='ID3') {
            const textDecoder = new TextDecoder('utf-8');
            const arr = new Uint8Array(s.data);
            const str = textDecoder.decode(arr).trim().replace(/\0/g,'');
            // Любой формат "Артист - Трек"
            if(str.includes(' - ')){
                const parts = str.split(' - ');
                currentMetadata.artist = parts[0].trim();
                currentMetadata.title = parts[1].trim();
            } else { currentMetadata.title = str; currentMetadata.artist = 'Радио МИР'; }
            updateTrackDisplay();
        }
    });
}

// Обновление отображения трека
function updateTrackDisplay() {
    const title = currentMetadata.title || 'Радио МИР';
    const artist = currentMetadata.artist || 'Прямой эфир';
    if(title+artist === lastMetadata) return;
    lastMetadata = title+artist;
    document.getElementById('currentSong').textContent = title;
    document.getElementById('currentArtist').textContent = artist;
    addToHistory(title,artist);
    document.getElementById('trackHistory').classList.add('expanded');
    updateStatus('В эфире: ' + title);
}

// История треков
function addToHistory(title,artist){
    const timestamp = new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'});
    if(trackHistory[0] && trackHistory[0].title===title && trackHistory[0].artist===artist) return;
    trackHistory.unshift({title,artist,timestamp,id:Date.now()});
    if(trackHistory.length>5) trackHistory = trackHistory.slice(0,5);
    updateHistoryDisplay();
}

function updateHistoryDisplay(){
    document.getElementById('historyList').innerHTML = trackHistory.map(t=>`
        <div class="history-item">
            <div class="history-track"><strong>${t.title}</strong> - ${t.artist}</div>
            <div class="history-time">${t.timestamp}</div>
        </div>
    `).join('');
}

// Play/Pause
function togglePlay(){
    if(!hls && !audio.src){ initHLS(); return; }
    if(isPlaying){ audio.pause(); showPlayIcon(); updateStatus('Пауза'); }
    else{ audio.play().then(()=>{ showPauseIcon(); updateStatus('Слушаем эфир...'); }).catch(()=>updateStatus('Ошибка воспроизведения')); }
    isPlaying = !isPlaying;
}

function showPlayIcon(){ playIcon.className='play-icon'; playIcon.innerHTML=''; }
function showPauseIcon(){ playIcon.className='pause-icon'; playIcon.innerHTML='<div class="pause-bar"></div><div class="pause-bar"></div>'; }
function updateStatus(msg){ document.getElementById('status').textContent = msg; }

// Автозапуск
document.addEventListener('DOMContentLoaded',()=>{ initHLS(); setVolume(60); });
function setVolume(value){ audio.volume = value/100; }
</script>
</body>
</html>
