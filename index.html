<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞–¥–∏–æ –ú–ò–†</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .logo-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(45deg, #ffffff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(255,255,255,0.3);
        }
        
        .slogan {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .player-card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .now-playing {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .station-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .station-badge {
            background: linear-gradient(45deg, #ff4081, #f50057);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .live-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
        }
        
        .live-dot {
            width: 6px;
            height: 6px;
            background: #ff5252;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .song-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            min-height: 32px;
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #ffffff, #bbdefb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .song-artist {
            font-size: 16px;
            opacity: 0.9;
            min-height: 22px;
            transition: all 0.3s ease;
            font-weight: 400;
        }
        
        .player-controls {
            margin: 35px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        .play-btn {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            border: none;
            color: white;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        
        .play-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }
        
        .play-btn:active {
            transform: scale(0.95);
        }
        
        .play-icon {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 18px 0 18px 32px;
            border-color: transparent transparent transparent white;
            margin-left: 4px;
        }
        
        .pause-icon {
            width: 32px;
            height: 36px;
            display: flex;
            justify-content: space-between;
        }
        
        .pause-bar {
            width: 10px;
            height: 100%;
            background: white;
            border-radius: 3px;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
        
        .status {
            font-size: 13px;
            opacity: 0.8;
            margin-top: 20px;
            text-align: center;
            font-weight: 300;
        }
        
        .footer {
            text-align: center;
            margin-top: 25px;
            font-size: 11px;
            opacity: 0.6;
            font-weight: 300;
        }
        
        .organization {
            font-size: 10px;
            opacity: 0.5;
            margin-top: 5px;
            line-height: 1.3;
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .track-history {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .history-title {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 10px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item {
            font-size: 11px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-track {
            flex: 1;
        }
        
        .history-time {
            opacity: 0.5;
            font-size: 10px;
            white-space: nowrap;
            margin-left: 10px;
        }
        
        .refresh-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .update-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            display: none;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="update-notification" id="updateNotification">–¢—Ä–µ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω</div>
    
    <div class="container fade-in">
        <div class="logo-section">
            <div class="logo">–ú–ò–†</div>
            <div class="slogan">–í—Å–µ –≤–∫–ª—é—á–µ–Ω–æ!</div>
        </div>
        
        <div class="player-card">
            <div class="now-playing">
                <div class="station-info">
                    <div class="station-badge">–≠–§–ò–†</div>
                    <div class="live-indicator">
                        <div class="live-dot"></div>
                        <span>LIVE</span>
                    </div>
                </div>
                <div class="song-title" id="currentSong">–ó–∞–≥—Ä—É–∑–∫–∞ —ç—Ñ–∏—Ä–∞...</div>
                <div class="song-artist" id="currentArtist">–†–∞–¥–∏–æ –ú–ò–†</div>
            </div>
            
            <div class="player-controls">
                <button class="play-btn" onclick="togglePlay()" id="playBtn">
                    <div class="play-icon" id="playIcon"></div>
                </button>
                <div class="volume-control">
                    <span>üîä</span>
                    <input type="range" min="0" max="100" value="60" class="volume-slider" id="volumeSlider" oninput="changeVolume(this.value)">
                </div>
            </div>
            
            <div class="status" id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —ç—Ñ–∏—Ä—É...</div>
            
            <div class="track-history" id="trackHistory">
                <div class="history-title">
                    <span>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–∫–æ–≤:</span>
                    <button class="refresh-btn" onclick="fetchCurrentTrack()" id="refreshBtn">
                        <span id="refreshIcon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
                <div id="historyList">
                    <div style="opacity:0.5; text-align:center; padding:10px;">
                        –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <div class="organization">
                –ú–µ–∂–≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–µ–ª–µ—Ä–∞–¥–∏–æ–∫–æ–º–ø–∞–Ω–∏—è ¬´–ú–ò–†¬ª<br>
                –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç: <a href="https://radiomir.by" style="color:rgba(255,255,255,0.7);">radiomir.by</a>
            </div>
        </div>
        
        <audio id="audioPlayer" preload="none"></audio>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const STREAM_URL = 'https://media1.datacenter.by:1936/radiomir/radiomir/playlist.m3u8';

        let hls;
        let isPlaying = false;
        let trackHistory = [];
        let trackUpdateInterval;
        let isUpdating = false;
        let lastTrackHash = '';

        // –§–æ–ª–±—ç–∫ —Ç—Ä–µ–∫–∏
        const fallbackTracks = [
            { title: "–ù–æ–≤–æ—Å—Ç–∏ –º–∏—Ä–∞", artist: "–†–∞–¥–∏–æ –ú–ò–†" },
            { title: "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —ç—Ñ–∏—Ä", artist: "–í—Å–µ –≤–∫–ª—é—á–µ–Ω–æ!" },
            { title: "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞", artist: "–†–∞–¥–∏–æ –ú–ò–†" },
            { title: "–•–∏—Ç-–ø–∞—Ä–∞–¥ –°–ù–ì", artist: "–†–∞–¥–∏–æ –ú–ò–†" },
            { title: "–£—Ç—Ä–µ–Ω–Ω–∏–π —ç—Ñ–∏—Ä", artist: "–†–∞–¥–∏–æ –ú–ò–†" }
        ];

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç—Ä–µ–∫–∞ —Å radiomir.by
        async function fetchCurrentTrack() {
            if (isUpdating) return;
            
            isUpdating = true;
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.innerHTML = '<span class="loading"></span>';
            refreshBtn.disabled = true;
            
            try {
                // –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–∏–Ω–≥ —Å radiomir.by/live
                let trackData = await parseRadioMirLive();
                
                // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                if (!trackData || !trackData.title) {
                    trackData = await parseAlternativeMethods();
                }
                
                // –§–æ–ª–±—ç–∫ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
                if (!trackData || !trackData.title) {
                    trackData = getRandomFallbackTrack();
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ç—Ä–µ–∫
                const trackHash = trackData.title + trackData.artist;
                if (trackHash !== lastTrackHash) {
                    lastTrackHash = trackHash;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    updateTrackDisplay(trackData.title, trackData.artist, trackData.source);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification('–¢—Ä–µ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω');
                    
                    // –õ–æ–≥–∏—Ä—É–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    console.log('–û–±–Ω–æ–≤–ª–µ–Ω —Ç—Ä–µ–∫:', trackData);
                }
                
                return trackData;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç—Ä–µ–∫–∞:', error);
                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞';
                return null;
            } finally {
                isUpdating = false;
                refreshIcon.innerHTML = 'üîÑ';
                refreshBtn.disabled = false;
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã radiomir.by/live
        async function parseRadioMirLive() {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º CORS –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞
                const proxyUrl = 'https://corsproxy.io/?';
                const targetUrl = 'https://radiomir.by/live';
                
                const response = await fetch(proxyUrl + encodeURIComponent(targetUrl), {
                    headers: {
                        'Accept': 'text/html',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º HTML –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
                window.lastHtml = html;
                
                // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π DOM –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // –ú–µ—Ç–æ–¥ 1: –ò—â–µ–º –ø–æ –º–µ—Ç–∞-—Ç–µ–≥–∞–º (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π)
                const metaTitle = doc.querySelector('meta[property="og:title"]');
                if (metaTitle) {
                    const content = metaTitle.getAttribute('content');
                    if (content && content.trim()) {
                        const parsed = parseTrackText(content);
                        if (parsed) {
                            parsed.source = 'meta og:title';
                            return parsed;
                        }
                    }
                }
                
                // –ú–µ—Ç–æ–¥ 2: –ò—â–µ–º –ø–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞–º (–∞–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∞–π—Ç–∞)
                const selectors = [
                    // –û—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è —Ä–∞–¥–∏–æ—Å—Ç–∞–Ω—Ü–∏–π
                    '.player-track', '.current-track', '.now-playing',
                    '.track-info', '.song-title', '.player-title',
                    '.player__song', '.player__track', '.on-air-track',
                    // –ë–æ–ª–µ–µ –æ–±—â–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
                    'h1', 'h2', 'h3', '.title', '.header', '.track'
                ];
                
                for (const selector of selectors) {
                    const elements = doc.querySelectorAll(selector);
                    for (const element of elements) {
                        const text = element.textContent.trim();
                        if (text && text.length > 3 && !isSiteText(text)) {
                            const parsed = parseTrackText(text);
                            if (parsed && parsed.title) {
                                parsed.source = `selector: ${selector}`;
                                return parsed;
                            }
                        }
                    }
                }
                
                // –ú–µ—Ç–æ–¥ 3: –ò—â–µ–º JavaScript –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                const scripts = doc.querySelectorAll('script');
                for (const script of scripts) {
                    if (script.textContent) {
                        const jsPatterns = [
                            /currentTrack\s*[:=]\s*["']([^"']+)["']/i,
                            /nowPlaying\s*[:=]\s*["']([^"']+)["']/i,
                            /track\s*[:=]\s*["']([^"']+)["']/i,
                            /title\s*[:=]\s*["']([^"']+)["']/i,
                            /artist\s*[:=]\s*["']([^"']+)["']/i,
                            /["']track["']\s*:\s*["']([^"']+)["']/i,
                            /["']artist["']\s*:\s*["']([^"']+)["']/i
                        ];
                        
                        for (const pattern of jsPatterns) {
                            const match = script.textContent.match(pattern);
                            if (match && match[1]) {
                                const parsed = parseTrackText(match[1]);
                                if (parsed) {
                                    parsed.source = 'javascript variable';
                                    return parsed;
                                }
                            }
                        }
                    }
                }
                
                // –ú–µ—Ç–æ–¥ 4: –ü–æ–∏—Å–∫ –ø–æ –≤—Å–µ–º—É —Ç–µ–∫—Å—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                const bodyText = doc.body.textContent;
                const lines = bodyText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 10 && line.length < 100);
                
                for (const line of lines) {
                    if (line.includes(' - ') || line.includes(' ‚Äì ') || line.includes(' ‚Äî ')) {
                        if (!isSiteText(line)) {
                            const parsed = parseTrackText(line);
                            if (parsed) {
                                parsed.source = 'text search';
                                return parsed;
                            }
                        }
                    }
                }
                
                return null;
                
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ radiomir.by:', error);
                return null;
            }
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
        async function parseAlternativeMethods() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º JSON API –µ—Å–ª–∏ –µ—Å—Ç—å
                const apiUrls = [
                    'https://radiomir.by/api/nowplaying',
                    'https://radiomir.by/nowplaying.json',
                    'https://radiomir.by/api/track'
                ];
                
                for (const url of apiUrls) {
                    try {
                        const proxyUrl = 'https://corsproxy.io/?';
                        const response = await fetch(proxyUrl + encodeURIComponent(url));
                        if (response.ok) {
                            const data = await response.json();
                            if (data.title || data.artist || data.song) {
                                return {
                                    title: data.title || data.song || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç—Ä–µ–∫',
                                    artist: data.artist || data.artist_name || '–†–∞–¥–∏–æ –ú–ò–†',
                                    source: 'api'
                                };
                            }
                        }
                    } catch (e) {
                        continue;
                    }
                }
                
                return null;
            } catch (error) {
                console.warn('–û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤:', error);
                return null;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–º (–Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞ –∏ —Ç.–¥.)
        function isSiteText(text) {
            const siteKeywords = [
                '—Ä–∞–¥–∏–æ', '–º–∏—Ä', 'radiomir', '–æ–Ω–ª–∞–π–Ω', '—Å–ª—É—à–∞—Ç—å',
                'live', '—Å—Ç—Ä–∏–º', '–ø–ª–µ–µ—Ä', 'player', '–≤–µ—â–∞–Ω–∏–µ',
                '—ç—Ñ–∏—Ä', 'stream', '–≤–µ—â–∞—Ç—å', '–æ–Ω–ª–∞–π–Ω —Ä–∞–¥–∏–æ',
                '–Ω–æ–≤–æ—Å—Ç–∏', '–ø—Ä–æ–≥—Ä–∞–º–º—ã', '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ'
            ];
            
            const lowerText = text.toLowerCase();
            return siteKeywords.some(keyword => lowerText.includes(keyword));
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ —Ç—Ä–µ–∫–∞
        function parseTrackText(text) {
            if (!text) return null;
            
            // –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞
            let cleanText = text.trim()
                .replace(/^–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç[: ]*/i, '')
                .replace(/^Now playing[: ]*/i, '')
                .replace(/^‚ñ∂\s*/, '')
                .replace(/^‚ô™\s*/, '')
                .replace(/^\d+\.\s*/, '') // –£–±–∏—Ä–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é "1. "
                .replace(/^‚Ä¢\s*/, '')
                .trim();
            
            // –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏ —Ç—Ä–µ–∫
            const separators = [' ‚Äì ', ' ‚Äî ', ' - ', ' | ', ' ‚Ä¢ ', ': ', ' ‚Äî ', '/'];
            
            for (const sep of separators) {
                if (cleanText.includes(sep)) {
                    const parts = cleanText.split(sep);
                    if (parts.length >= 2) {
                        let artist = parts[0].trim();
                        let title = parts.slice(1).join(sep).trim();
                        
                        // –ò–Ω–æ–≥–¥–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–∞–æ–±–æ—Ä–æ—Ç: —Ç—Ä–µ–∫ - –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                        if (title.length < artist.length && title.split(' ').length < 3) {
                            [artist, title] = [title, artist];
                        }
                        
                        return {
                            artist: artist || '–†–∞–¥–∏–æ –ú–ò–†',
                            title: title || '–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞',
                            raw: text
                        };
                    }
                }
            }
            
            // –ï—Å–ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
            return {
                artist: '–†–∞–¥–∏–æ –ú–ò–†',
                title: cleanText || '–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —ç—Ñ–∏—Ä',
                raw: text
            };
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ñ–æ–ª–±—ç–∫ —Ç—Ä–µ–∫–∞
        function getRandomFallbackTrack() {
            const track = fallbackTracks[Math.floor(Math.random() * fallbackTracks.length)];
            return {
                ...track,
                source: 'fallback'
            };
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—Ä–µ–∫–∞
        function updateTrackDisplay(title, artist, source = '') {
            const songElement = document.getElementById('currentSong');
            const artistElement = document.getElementById('currentArtist');
            const statusElement = document.getElementById('status');
            
            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            songElement.style.opacity = '0.5';
            artistElement.style.opacity = '0.5';
            
            setTimeout(() => {
                songElement.textContent = title || '–†–∞–¥–∏–æ –ú–ò–†';
                artistElement.textContent = artist || '–ü—Ä—è–º–æ–π —ç—Ñ–∏—Ä';
                
                songElement.style.opacity = '1';
                artistElement.style.opacity = '1';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                if (title && artist) {
                    addToHistory(title, artist, source);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                const time = new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
                statusElement.textContent = `üéµ ${time} | ${title || '–í —ç—Ñ–∏—Ä–µ'}`;
                
            }, 300);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
        function addToHistory(title, artist, source = '') {
            const timestamp = new Date().toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –ª–∏ —Ç—Ä–µ–∫
            const lastTrack = trackHistory[0];
            if (lastTrack && 
                lastTrack.title === title && 
                lastTrack.artist === artist &&
                (Date.now() - lastTrack.id) < 60000) { // 1 –º–∏–Ω—É—Ç–∞
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            trackHistory.unshift({
                title,
                artist,
                source,
                timestamp,
                id: Date.now()
            });
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 15 —Ç—Ä–µ–∫–∞–º–∏
            if (trackHistory.length > 15) {
                trackHistory = trackHistory.slice(0, 15);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
            updateHistoryDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
        function updateHistoryDisplay() {
            const historyList = document.getElementById('historyList');
            
            if (trackHistory.length === 0) {
                historyList.innerHTML = '<div style="opacity:0.5; text-align:center; padding:10px;">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–∫–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å</div>';
                return;
            }
            
            historyList.innerHTML = trackHistory.map(track => `
                <div class="history-item">
                    <div class="history-track">
                        <strong>${track.title}</strong><br>
                        <span style="opacity:0.8; font-size:10px;">${track.artist}</span>
                    </div>
                    <div class="history-time" title="${track.source || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}">
                        ${track.timestamp}
                    </div>
                </div>
            `).join('');
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message) {
            const notification = document.getElementById('updateNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 2000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HLS –ø–ª–µ–µ—Ä–∞
        function initHLS() {
            if (Hls.isSupported()) {
                hls = new Hls({
                    enableWorker: false,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    debug: false
                });
                hls.loadSource(STREAM_URL);
                hls.attachMedia(audio);
                
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    document.getElementById('status').textContent = '–≠—Ñ–∏—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω ‚úì';
                });
                
                hls.on(Hls.Events.ERROR, (event, data) => {
                    console.error('HLS Error:', data);
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –º–µ–¥–∏–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...';
                                hls.recoverMediaError();
                                break;
                            default:
                                document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —ç—Ñ–∏—Ä—É';
                                break;
                        }
                    }
                });
                
            } else if (audio.canPlayType('application/vnd.apple.mpegurl')) {
                audio.src = STREAM_URL;
                document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —ç—Ñ–∏—Ä—É...';
            } else {
                document.getElementById('status').textContent = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—é';
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º
        function togglePlay() {
            if (!hls && !audio.src) {
                initHLS();
                document.getElementById('status').textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                return;
            }
            
            if (isPlaying) {
                audio.pause();
                showPlayIcon();
                document.getElementById('status').textContent = '–ü–∞—É–∑–∞';
            } else {
                audio.play().then(() => {
                    showPauseIcon();
                    document.getElementById('status').textContent = '–°–ª—É—à–∞–µ–º —ç—Ñ–∏—Ä...';
                }).catch((error) => {
                    console.error('Play error:', error);
                    document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è';
                });
            }
            isPlaying = !isPlaying;
        }

        function showPlayIcon() {
            playIcon.className = 'play-icon';
            playIcon.innerHTML = '';
        }

        function showPauseIcon() {
            playIcon.className = 'pause-icon';
            playIcon.innerHTML = '<div class="pause-bar"></div><div class="pause-bar"></div>';
        }

        function changeVolume(value) {
            audio.volume = value / 100;
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–æ–≤
        function startTrackUpdater() {
            // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É
            setTimeout(() => fetchCurrentTrack(), 1000);
            
            // –ó–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            trackUpdateInterval = setInterval(() => {
                fetchCurrentTrack();
            }, 30000);
            
            // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    fetchCurrentTrack();
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏–æ
        audio.addEventListener('play', () => {
            showPauseIcon();
            isPlaying = true;
            document.getElementById('status').textContent = '–≠—Ñ–∏—Ä –æ–Ω–ª–∞–π–Ω';
        });
        
        audio.addEventListener('pause', () => {
            showPlayIcon();
            isPlaying = false;
            document.getElementById('status').textContent = '–ü–∞—É–∑–∞';
        });
        
        audio.addEventListener('waiting', () => {
            document.getElementById('status').textContent = '–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è...';
        });
        
        audio.addEventListener('playing', () => {
            document.getElementById('status').textContent = '–≠—Ñ–∏—Ä –æ–Ω–ª–∞–π–Ω';
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            audio.volume = 0.6;
            initHLS();
            startTrackUpdater();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
            document.getElementById('volumeSlider').value = 60;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            setTimeout(() => {
                addToHistory('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', '–†–∞–¥–∏–æ –ú–ò–†', 'system');
            }, 500);
        });

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        window.debug = {
            fetchCurrentTrack,
            trackHistory: () => trackHistory,
            lastTrack: () => trackHistory[0],
            forceUpdate: () => {
                lastTrackHash = '';
                fetchCurrentTrack();
            }
        };
    </script>
</body>
</html>
